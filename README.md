# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:

- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:

- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск

Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```

## Сборка

```
npm run build
```

или

```
yarn build
```

## Архитектура

Архитектура приложения основана на паттерне MVP (Model-View-Presenter), что обеспечивает четкое разделение логики, представления и данных. Каждый компонент архитектуры выполняет свою роль, что делает код модульным, тестируемым и поддерживаемым.

### Ключевые особенности архитектуры

- Модульность: Каждый компонент имеет четко определенную ответственность, что упрощает тестирование и поддержку.
- Реактивность: Использование системы событий (`EventEmitter`) позволяет легко уведомлять другие части приложения об изменениях.
- Универсальность: Базовые классы (`Component<T>`, `Model<T>`) обеспечивают повторное использование кода и расширяемость.
- Интеграция с API: Класс `Api` предоставляет унифицированный способ взаимодействия с сервером, включая обработку ошибок.
- Гибкость: Компоненты могут быть легко адаптированы для новых требований благодаря использованию коллбэков, параметров и типизации.

## Базовый код

### 1. Класс `Api`

Класс `Api` представляет собой универсальный инструмент для работы с HTTP-запросами. Он предоставляет методы для выполнения GET и POST-подобных запросов (включая PUT и DELETE) к удаленному серверу. Класс поддерживает настройку базового URL и параметров запроса, таких как заголовки, и предоставляет обработку ответов от сервера.

`constructor(baseUrl: string, options: RequestInit = {})` Конструктор принимает базовый URL (`baseUrl`) для API и опциональные параметры запроса (`options`). Параметры запроса могут включать заголовки, таймауты и другие настройки. Если заголовки не переданы, по умолчанию используется заголовок `'Content-Type': 'application/json'`.

#### Поля класса

- `readonly baseUrl: string` Хранит базовый URL для всех запросов. Этот URL используется как префикс для всех URI, передаваемых в методы `get` и `post`.
- `protected options: RequestInit` Хранит параметры запроса, такие как заголовки, методы и другие настройки. Эти параметры применяются ко всем запросам, выполняемым через экземпляр класса.

#### Методы класса

- `protected handleResponse(response: Response): Promise<object>` Обрабатывает HTTP-ответ от сервера. Если статус ответа успешный (`response.ok`), метод возвращает JSON-данные. В противном случае он создает ошибку, используя поле `error` из JSON-ответа или текст состояния HTTP.
- `get(uri: string)` Выполняет GET-запрос к указанному URI. Метод добавляет URI к базовому URL и отправляет запрос с использованием параметров, определенных в `options`. Результат обрабатывается методом `handleResponse`.
- `post(uri: string, data: object, method: ApiPostMethods = 'POST')` Выполняет POST-, PUT- или DELETE-запрос к указанному URI. Метод принимает данные (`data`), которые будут отправлены в теле запроса, и тип HTTP-метода (`method`). По умолчанию используется метод `POST`. Данные преобразуются в JSON-формат перед отправкой. Результат обрабатывается методом `handleResponse`.

#### Типы, связанные с классом

- `ApiListResponse<Type>` Тип описывает структуру ответа от сервера, содержащего список элементов. Содержит два поля:

  - `total: number` — общее количество элементов.
  - `items: Type[]` — массив элементов типа `Type`.

- `ApiPostMethods` Тип описывает допустимые HTTP-методы для метода `post`: `'POST'`, `'PUT'`, `'DELETE'`.

Класс `Api` предоставляет удобный и унифицированный способ взаимодействия с сервером через HTTP-запросы. Его методы позволяют выполнять основные операции CRUD (создание, чтение, обновление, удаление) с данными, а использование типов, таких как `ApiListResponse<Type>` и `ApiPostMethods`, делает код более безопасным и читаемым.

### 2. Класс `Component<T>`

Класс `Component<T>` представляет собой абстрактный базовый класс для создания компонентов пользовательского интерфейса. Он предоставляет инструментарий для работы с DOM-элементами, такими как управление классами, текстовым содержимым, состоянием блокировки, видимостью, изображениями и т.д. Этот класс является универсальным и может быть расширен для создания специализированных компонентов.

`constructor(protected readonly container: HTMLElement)` Конструктор принимает корневой DOM-элемент компонента, который будет использоваться всеми методами класса для выполнения операций с DOM.

#### Поля класса

- `protected readonly container: HTMLElement` Хранит ссылку на корневой DOM-элемент, который является контейнером для компонента.

#### Методы класса

- `toggleClass(element: HTMLElement, className: string, force?: boolean):void` Переключает указанный класс для элемента. Если параметр `force` не передан, класс будет добавлен, если его нет, и удален, если он уже существует. Если `force` указан, то класс будет добавлен (`true`) или удален (`false`), независимо от текущего состояния.
- `setText(element: HTMLElement, value: unknown): void` Устанавливает текстовое содержимое элемента. Если `value` равно `null` или `undefined`, оно будет преобразовано в пустую строку.
- `setDisabled(element: HTMLElement, state: boolean): void` Блокирует или разблокирует элемент, добавляя или удаляя атрибут `disabled`.
- `setHidden(element: HTMLElement): void` Скрывает элемент, устанавливая его стиль `display` в значение `none`.
- `setVisible(element: HTMLElement): void` Показывает элемент, удаляя свойство `display` из его стилей.
- `setImage(element: HTMLImageElement, src: string, alt?: string): void` Устанавливает атрибут `src` для изображения и, при необходимости, альтернативный текст (`alt`).
- `render(data?: Partial<T>): HTMLElement` Применяет переданные данные к текущему экземпляру компонента (если они есть) и возвращает корневой DOM-элемент. Используется для рендеринга компонента.

Класс `Component<T>` предоставляет мощный и гибкий инструментарий для создания UI-компонентов. Его методы позволяют легко манипулировать DOM-элементами, а абстрактная природа класса делает его удобным для расширения в дочерних классах.

### 3. Класс `EventEmitter`

Класс `EventEmitter` представляет собой реализацию брокера событий, который позволяет подписываться на события, генерировать их и управлять обработчиками. Этот класс предоставляет универсальный механизм для работы с событиями в приложении, поддерживая как точечные подписки на конкретные события, так и глобальные подписки на все события.

`constructor()` Конструктор инициализирует внутреннюю карту `_events`, которая хранит события и связанные с ними обработчики. Карта использует типы `EventName` (строка или регулярное выражение) в качестве ключей и множества обработчиков (`Set<Subscriber>`) в качестве значений.

#### Поля класса

- `_events: Map<EventName, Set<Subscriber>>` Хранит все зарегистрированные события и их обработчики. Ключами являются имена событий (`EventName`), а значениями — множества функций-обработчиков (`Set<Subscriber>`).

#### Методы класса

- `on<T extends object>(eventName: EventName, callback: (event: T) => void): void` Подписывает обработчик на указанное событие. Если событие еще не зарегистрировано, создается новое множество обработчиков. Обработчик добавляется в множество для указанного события.
- `off(eventName: EventName, callback: Subscriber): void` Удаляет обработчик из множества для указанного события. Если после удаления обработчика множество становится пустым, событие удаляется из карты `_events`.
- `emit<T extends object>(eventName: string, data?: T): void` Генерирует событие с указанным именем и данными. Все обработчики, подписанные на это событие, вызываются с переданными данными. Также поддерживаются подписки на все события (`'*'`) и подписки по шаблону (с использованием регулярных выражений).
- `onAll(callback: (event: EmitterEvent) => void): void` Подписывает обработчик на все события. При возникновении любого события будет вызван указанный обработчик с объектом, содержащим имя события и данные.
- `offAll(): void` Очищает все зарегистрированные события и обработчики. Полностью сбрасывает карту `_events`.
- `trigger<T extends object>(eventName: string, context?: Partial<T>): (data: T) => void` Создает функцию-триггер, которая генерирует событие с указанным именем при вызове. Триггер может комбинировать данные, переданные при вызове, с контекстом, указанным при создании триггера.

#### Типы, связанные с классом

- `EventName` Тип описывает имя события. Может быть строкой или регулярным выражением, что позволяет подписываться на события по шаблону.
- `Subscriber` Тип описывает функцию-обработчик события. Обработчик принимает данные, связанные с событием.
- `EmitterEvent` Тип описывает структуру данных, передаваемых в обработчики при подписке на все события ('\*'). Содержит два поля:
  - `eventName: string` — имя события.
  - `data: unknown` — данные, связанные с событием.
- `IEvents` Интерфейс описывает методы, которые должен реализовывать класс `EventEmitter`. Включает методы `on`, `emit` и `trigger`.

Класс `EventEmitter` предоставляет мощный и гибкий механизм для управления событиями в приложении. Его методы позволяют легко подписываться на события, генерировать их и управлять обработчиками, что делает его удобным инструментом для организации взаимодействия между компонентами.

### 4. Класс `Model<T>`

Класс `Model<T>` представляет собой абстрактный базовый класс для создания моделей данных. Он предоставляет механизм для хранения и управления данными, а также интеграции с системой событий через интерфейс `IEvents`. Этот класс позволяет отличать модели от простых объектов данных и уведомлять другие части приложения об изменениях в модели.

`constructor(data: Partial<T>, protected events: IEvents)`
Конструктор принимает частичные данные (`data`) для инициализации модели и экземпляр `IEvents` для работы с событиями. Данные копируются в модель с помощью `Object.assign`, что позволяет гибко задавать начальное состояние.

#### Поля класса

- `protected events: IEvents` Хранит ссылку на экземпляр системы событий (`IEvents`). Используется для уведомления других компонентов о изменениях в модели.

#### Методы класса

- `emitChanges(event: string, payload?: object): void` Генерирует событие, уведомляя подписчиков о том, что модель изменилась. Метод принимает имя события (`event`) и опциональные данные (`payload`). Если данные не переданы, используется пустой объект `{}`. Этот метод позволяет другим компонентам реагировать на изменения в модели.

#### Типы, связанные с классом

- `isModel(obj: unknown): obj is Model<any>` Функция-гарда для проверки, является ли объект экземпляром класса `Model`. Возвращает `true`, если объект является моделью, и `false` в противном случае. Это полезно для типизации и проверки данных в рантайме.
- `IEvents` Интерфейс, описывающий систему событий. Предоставляет методы для подписки на события (`on`), генерации событий (`emit`) и создания триггеров (`trigger`).

Класс `Model<T>` предоставляет универсальный и расширяемый способ управления данными в приложении. Его абстрактная природа позволяет создавать специализированные модели, а интеграция с системой событий делает его удобным для использования в архитектуре MVP или других паттернах, где требуется реактивность.

## Model (Модель)

### 1. Класс `ProductModel`

Класс `ProductModel` реализует модель для хранения и управления данными о продуктах в приложении. Он наследуется от базового класса `Model<IProduct>` и предназначен только для работы с локальными данными (без запросов к API). Класс интегрируется с системой событий через интерфейс `IEvents` и предоставляет методы для обновления состояния продуктов и отдельных товаров.

#### Конструктор

`constructor(data: Partial<IProduct>, events: IEvents)`

- Принимает начальные данные продукта (`data`) и экземпляр системы событий (`events`).
- Вызывает конструктор базового класса `Model<IProduct>` для инициализации состояния.

#### Методы класса

- `setProducts(products: IProduct[]): void`
  - Принимает массив продуктов и эмитит событие `products:loaded` с новым списком продуктов.
- `setProduct(product: IProduct): void`
  - Принимает отдельный продукт и эмитит событие `product:loaded` с данными этого продукта.

#### Типы, связанные с классом

- `IProduct` - интерфейс, описывающий структуру объекта продукта.
- `IEvents` - интерфейс системы событий, используется для генерации событий:
  - `products:loaded` - при загрузке списка продуктов.
  - `product:loaded` - при загрузке отдельного продукта.

#### Итог

Класс `ProductModel` обеспечивает централизованное хранение и обновление данных о продуктах, а также уведомление других компонентов приложения о любых изменениях через систему событий. Это делает его ключевым звеном в архитектуре управления состоянием приложения.

### 2. Класс `OrderModel`

Класс `OrderModel` реализует модель для хранения и валидации данных заказа в приложении. Он наследуется от базового класса `Model<IOrder>` и предназначен только для локального управления состоянием заказа (без запросов к API). Класс интегрируется с системой событий через интерфейс `IEvents` и предоставляет методы для валидации данных заказа и генерации событий валидации.

#### Конструктор

`constructor(data: Partial<IOrder>, events: IEvents)`

- Принимает начальные данные заказа (`data`) и экземпляр системы событий (`events`).
- Вызывает конструктор базового класса `Model<IOrder>` для инициализации состояния.

#### Методы класса

- `validate(data: Partial<IOrder>): { valid: boolean; errors: string[] }`

  - Выполняет валидацию переданных данных заказа.
  - Проверяет наличие обязательных полей: способ оплаты (`payment`), адрес (`address`), email (`email`), телефон (`phone`), а также наличие товаров в корзине (`items`).
  - Возвращает объект с флагом валидности (`valid`) и массивом сообщений об ошибках (`errors`).

- `validateOrder(orderData: IOrder): boolean`
  - Выполняет полную валидацию заказа, используя метод `validate`.
  - Если валидация не пройдена, эмитит событие `order:validate` с подробным описанием ошибок.
  - Возвращает результат валидации (`true` - если ошибок нет, `false` - если есть ошибки).

#### Типы, связанные с классом

- `IOrder` - интерфейс, описывающий структуру объекта заказа.
- `IEvents` - интерфейс системы событий, используется для генерации событий:
  - `order:validate` - при ошибках валидации заказа, с подробным описанием ошибок.

#### Итог

Класс `OrderModel` обеспечивает централизованное хранение и валидацию данных заказа, а также уведомление других компонентов приложения о результатах валидации через систему событий. Это делает его ключевым звеном в архитектуре управления оформлением заказа.

### 3. Класс `AppState`

Класс `AppState` реализует модель для хранения и управления глобальным состоянием приложения. Он наследуется от базового класса `Model<IAppState>` и предназначен для централизованного управления каталогом товаров, корзиной, предпросмотром, заказом, состоянием загрузки и способом оплаты. Класс интегрируется с системой событий через интерфейс `IEvents` и взаимодействует с моделями продуктов и заказов.

#### Конструктор

`constructor(events: IEvents, productModel: ProductModel, orderModel: OrderModel)`

- Принимает экземпляр системы событий (`events`), модель продуктов (`productModel`) и модель заказов (`orderModel`).
- Инициализирует внутреннее состояние приложения (`state`) с начальными значениями.
- Сохраняет ссылки на связанные модели для взаимодействия.

#### Поля класса

- `state: IAppState` - текущее состояние приложения (каталог, корзина, предпросмотр, заказ, загрузка, способ оплаты).
- `productModel: ProductModel` - ссылка на модель продуктов.
- `orderModel: OrderModel` - ссылка на модель заказов.
- `_address: string` - приватное поле для хранения адреса доставки.

#### Методы класса

- `private set(nextState: Partial<IAppState>): void` - обновляет состояние приложения и эмитит событие `state:updated`.
- `setProducts(products: IProduct[]): void` - обновляет каталог товаров и синхронизирует его с моделью продуктов.
- `setProduct(product: IProduct): void` - обновляет отдельный товар в модели продуктов.
- `addToBasket(productId: string): void` - добавляет товар в корзину, эмитит событие и обновляет счетчик.
- `removeFromBasket(productId: string): void` - удаляет товар из корзины, эмитит событие и обновляет счетчик.
- `clearBasket(): void` - очищает корзину, эмитит событие и обновляет счетчик.
- `setPreview(productId: string | null): void` - устанавливает текущий предпросмотр товара и эмитит событие.
- `getBasketItems(): IBasketItem[]` - возвращает массив товаров, находящихся в корзине, с их данными.
- `calculateBasketTotal(): number` - возвращает общую стоимость товаров в корзине.
- `placeOrder(orderData: IOrder): void` - выполняет валидацию заказа, сохраняет его, очищает корзину и эмитит событие о размещении заказа.
- `updateBasketCounter(): void` - эмитит событие с текущим количеством товаров в корзине.
- `setPaymentMethod(method: 'online' | 'cash' | null): void` - устанавливает способ оплаты и эмитит событие.
- `getPaymentMethod(): 'online' | 'cash' | null` - возвращает текущий способ оплаты.
- `getCatalog(): IProduct[]` - возвращает текущий каталог товаров.
- `getBasket(): string[]` - возвращает массив идентификаторов товаров в корзине.
- `isInBasket(productId: string): boolean` - проверяет, находится ли товар в корзине.
- `getAddress(): string` - возвращает текущий адрес доставки.
- `setAddress(address: string): void` - устанавливает адрес доставки.

#### Типы, связанные с классом

- `IAppState` - интерфейс состояния приложения (каталог, корзина, предпросмотр, заказ, загрузка, способ оплаты).
- `IProduct` - интерфейс товара.
- `IOrder` - интерфейс заказа.
- `IBasketItem` - интерфейс товара в корзине.
- `IEvents` - интерфейс системы событий.

#### События

- `state:updated` - при обновлении состояния приложения.
- `basket:updated` - при изменении содержимого корзины.
- `basket:counter` - при обновлении счетчика корзины.
- `preview:changed` - при изменении предпросмотра товара.
- `order:placed` - при успешном размещении заказа.
- `payment:method` - при изменении способа оплаты.

#### Итог

Класс `AppState` обеспечивает централизованное управление состоянием приложения, синхронизацию с моделями продуктов и заказов, а также генерацию событий для обновления пользовательского интерфейса и взаимодействия между компонентами. Это делает его ключевым элементом архитектуры приложения и удобной точкой для управления всеми пользовательскими сценариями.

## View (Представление)

### 1. Класс `Basket`

Класс `Basket` представляет собой компонент для управления корзиной товаров в пользовательском интерфейсе. Он наследуется от базового класса `View<IBasketView>` и предоставляет функциональность для отображения списка товаров, общей стоимости и взаимодействия с кнопкой оформления заказа. Класс интегрируется с системой событий через `EventEmitter`, что позволяет уведомлять другие части приложения о действиях пользователя.

#### Конструктор

`constructor(container: HTMLElement, events: EventEmitter)`

- Принимает контейнер корзины (`container`) и экземпляр системы событий (`events`).
- Инициализирует элементы интерфейса: список товаров (`listElement`), поле общей стоимости (`totalElement`) и кнопку оформления заказа (`buttonElement`).
- Добавляет обработчик события: клик по кнопке оформления заказа генерирует событие `order:open`.

#### Поля класса

- `listElement: HTMLElement` - хранит ссылку на элемент, представляющий список товаров в корзине. Используется для динамического добавления или удаления товаров.
- `totalElement: HTMLElement` - хранит ссылку на элемент, отображающий общую стоимость товаров в корзине.
- `buttonElement: HTMLElement` - хранит ссылку на кнопку оформления заказа. Кнопка становится активной только при наличии товаров в корзине.
- `cloneCardBasketTemplate: () => HTMLElement` - публичное свойство-фабрика для клонирования шаблона элемента товара в корзине.

#### Методы класса

- `getContainer(): HTMLElement` - возвращает контейнер корзины.
- `render(data: IBasketView): HTMLElement` - основной метод для отображения корзины:
  - Создаёт элементы для каждого товара с помощью `cloneCardBasketTemplate`.
  - Заполняет индексы, названия и цены товаров, добавляет обработчик удаления.
  - Очищает и наполняет список товаров, либо показывает сообщение "Корзина пуста".
  - Обновляет состояние кнопки оформления заказа (активна, если есть товары).
  - Устанавливает общую стоимость.
  - Возвращает контейнер корзины после рендера.

#### Типы, связанные с классом

- `IBasketView` - интерфейс, описывающий структуру данных для корзины:
  - `items: IBasketItem[]` - массив товаров в корзине.
  - `total: number` - общая стоимость товаров в корзине.
- `IBasketItem` - интерфейс отдельного товара в корзине:
  - `id: string` - уникальный идентификатор товара.
  - `title: string` - название товара.
  - `price: number | null` - цена товара (может быть `null`, если товар бесплатный).
- `EventEmitter` - класс системы событий, используется для генерации событий:
  - `order:open` - при клике на кнопку оформления заказа.
  - `basket:item-removed` - при удалении товара из корзины.

#### Итог

Класс `Basket` предоставляет удобный и унифицированный способ управления корзиной товаров. Его методы позволяют легко обновлять интерфейс корзины, управлять состоянием кнопки оформления заказа и взаимодействовать с другими компонентами через систему событий. Наследование от `View<IBasketView>` делает его расширяемым и совместимым с архитектурой приложения.

### 2. Класс `Form<T>`

Класс `Form<T>` представляет собой абстрактный компонент для управления формами в пользовательском интерфейсе. Он наследуется от базового класса `Component<IFormState>` и предоставляет функциональность для обработки ввода, валидации, отображения ошибок и управления состоянием кнопки отправки. Класс интегрируется с системой событий через интерфейс `IEvents`, что позволяет уведомлять другие части приложения о действиях пользователя.

#### Конструктор

`constructor(container: HTMLFormElement, events: IEvents)`

- Принимает контейнер формы (`container`) и экземпляр системы событий (`events`).
- Инициализирует элементы интерфейса:
  - Кнопку отправки формы (`submitButtonElement`).
  - Элемент для отображения ошибок (`errorsElement`), ищет сначала в `.modal__actions`, затем в корне формы.
- Добавляет обработчики событий:
  - На ввод в поля формы: вызывает `onInputChange` и `validateForm`.
  - На отправку формы: предотвращает стандартное поведение и эмитит событие `<имя_формы>:submit`, если форма валидна.

#### Поля класса

- `submitButtonElement: HTMLButtonElement` - ссылка на кнопку отправки формы.
- `errorsElement: HTMLElement` - ссылка на элемент для вывода ошибок.
- `_errors: string[]` - массив текущих ошибок формы.
- `_valid: boolean` - текущее состояние валидности формы.

#### Методы класса

- `onInputChange(field: keyof T, value: string): void` - эмитит событие `<имя_формы>.<имя_поля>:change` при изменении значения поля.
- `set valid(value: boolean)` / `get valid(): boolean` - геттер и сеттер для валидности формы; включает или выключает кнопку отправки.
- `set errors(value: string[])` / `get errors(): string[]` - геттер и сеттер для массива ошибок; обновляет отображение ошибок.
- `setErrors(errors: string[]): void` - обновляет текст ошибок в интерфейсе.
- `validateForm(): boolean` - базовая функция валидации (по умолчанию всегда true, переопределяется в наследниках).
- `setFieldError(field: keyof T, error: string): void` - отмечает поле как ошибочное и добавляет ошибку в массив.
- `clearFieldError(field: keyof T): void` - снимает ошибку с поля и удаляет соответствующее сообщение из массива ошибок.
- `render(state: Partial<T> & IFormState): HTMLFormElement` - обновляет состояние формы: валидность, ошибки и значения полей, возвращает контейнер формы.

#### Типы, связанные с классом

- `IFormState` - интерфейс состояния формы:
  - `valid: boolean` - валидна ли форма.
  - `errors: string[]` - массив ошибок.
- `IEvents` - интерфейс системы событий, используется для генерации событий:
  - `<имя_формы>:submit` - при попытке отправки формы.
  - `<имя_формы>.<имя_поля>:change` - при изменении значения поля.

#### Итог

Класс `Form<T>` предоставляет универсальный и расширяемый способ управления формами в приложении. Его методы позволяют легко реализовать валидацию, обработку ошибок, управление состоянием кнопки отправки и интеграцию с системой событий. Наследование от `Component<IFormState>` делает его совместимым с архитектурой приложения и позволяет создавать конкретные формы с минимальным повторением кода.

### 3. Класс `Modal`

Класс `Modal` реализует компонент модального окна для отображения различных интерфейсных состояний (предпросмотр товара, корзина, формы заказа и т.д.). Наследуется от базового класса `Component<IModalData>` и предоставляет методы для управления содержимым, открытия, закрытия и обработки пользовательских событий. Интегрируется с системой событий через интерфейс `IEvents`, что позволяет уведомлять другие части приложения о действиях пользователя.

#### Конструктор

`constructor(container: HTMLElement, events: IEvents)`

- Принимает контейнер модального окна (`container`) и экземпляр системы событий (`events`).
- Инициализирует элементы интерфейса:
  - Кнопку закрытия модального окна (`_closeButton`).
  - Контейнер для содержимого модального окна (`_content`).
- Добавляет обработчики событий:
  - Клик по кнопке закрытия или по фону модального окна вызывает метод `close()`.
  - Клик внутри содержимого модального окна не закрывает окно (остановка всплытия).
  - Обработка нажатия клавиши Escape для закрытия окна.

#### Поля класса

- `_closeButton: HTMLButtonElement` - кнопка закрытия модального окна.
- `_content: HTMLElement` - контейнер для динамического содержимого модального окна.

#### Методы класса

- `set content(value: HTMLElement)` - заменяет содержимое модального окна на переданный элемент.
- `toggleModal(state: boolean = true)` - открывает или закрывает модальное окно, добавляя или убирая CSS-класс активности.
- `handleEscape(evt: KeyboardEvent)` - обработчик нажатия клавиши Escape для закрытия модального окна.
- `getContent(): HTMLElement` - возвращает текущий контейнер содержимого модального окна.
- `open()` - открывает модальное окно, добавляет обработчик Escape, эмитит событие `modal:open`.
- `close()` - закрывает модальное окно, удаляет обработчик Escape, очищает содержимое, эмитит событие `modal:close`.
- `render(data: IModalData): HTMLElement` - устанавливает новое содержимое и открывает модальное окно.

#### Типы, связанные с классом

- `IModalData` - интерфейс, описывающий структуру данных для модального окна:
  - `content: HTMLElement` - содержимое, отображаемое в модальном окне.
- `IEvents` - интерфейс системы событий, используется для генерации событий:
  - `modal:open` - при открытии модального окна.
  - `modal:close` - при закрытии модального окна.

#### Итог

Класс `Modal` обеспечивает универсальный механизм отображения всплывающих окон в приложении. Его методы позволяют легко управлять содержимым, состоянием и поведением модального окна, а также интегрироваться с системой событий для взаимодействия с другими компонентами интерфейса.

### 4. Класс `Success`

Класс `Success` реализует компонент отображения успешного завершения заказа в пользовательском интерфейсе. Он наследуется от базового класса `Component<ISuccess>` и предоставляет методы для отображения суммы списанных синапсов и обработки пользовательского действия по закрытию окна успеха.

#### Конструктор

`constructor(container: HTMLElement, actions: ISuccessActions)`

- Принимает контейнер для отображения сообщения об успехе (`container`) и объект с обработчиками действий (`actions`).
- Инициализирует элементы интерфейса:
  - Кнопку закрытия окна успеха (`_close`).
  - Элемент для отображения суммы списанных синапсов (`_total`).
- Добавляет обработчик события:
  - Клик по кнопке закрытия вызывает функцию `onClick` из переданных действий.

#### Поля класса

- `_close: HTMLElement` - кнопка закрытия окна успеха.
- `_total: HTMLElement` - элемент для отображения суммы списанных синапсов.

#### Методы класса

- `set total(total: number)` - устанавливает и отображает сумму списанных синапсов в элементе `_total` в формате `Списано {total} синапсов`.

#### Типы, связанные с классом

- `ISuccess` - интерфейс, описывающий структуру данных для компонента успеха:
  - `total: number` - сумма списанных синапсов.
- `ISuccessActions` - интерфейс для передачи обработчиков действий:
  - `onClick: () => void` - функция, вызываемая при клике на кнопку закрытия.

#### Итог

Класс `Success` предоставляет простой и удобный способ отображения сообщения об успешном завершении заказа с указанием списанной суммы и обработкой пользовательского действия по закрытию окна успеха. Наследование от `Component<ISuccess>` делает его совместимым с архитектурой приложения и позволяет легко интегрировать в общий процесс оформления заказа.

### 5. Класс `Card`

Класс `Card` реализует компонент карточки товара для отображения в каталоге. Он наследуется от базового класса `ProductView` и предоставляет методы для управления состоянием карточки, обработкой пользовательских событий и интеграции с системой событий через интерфейс `IEvents`.

#### Конструктор

`constructor(container: HTMLElement, events: IEvents)`

- Принимает контейнер карточки (`container`) и экземпляр системы событий (`events`).
- Инициализирует элементы интерфейса, необходимые для работы карточки:
  - Заголовок товара (`_title`) - унаследовано от `ProductView`
  - Цена товара (`_price`) - унаследовано от `ProductView`
  - Категория товара (`_category`) - унаследовано от `ProductView`
  - Изображение товара (`_image`) - унаследовано от `ProductView`
  - Описание товара (`_description`) - унаследовано от `ProductView`
  - Корневой элемент для клика (`_button`) - поле класса `Card`
- Добавляет обработчик клика:
  - Если клик был не по кнопке "В корзину" или товар не бесплатный - эмитит событие `product:selected` с идентификатором товара.

#### Поля класса

- `_button: HTMLElement` - корневой элемент карточки для клика.

> Остальные поля (`_title`, `_price`, `_category`, `_image`, `_description`) определены и инициализируются в базовом классе `ProductView`.

#### Методы класса

- `override set price(value: number | null)` - переопределяет сеттер цены, вызывает базовую реализацию и дополнительно управляет состоянием и классом кнопки "В корзину".
- `render(data: IProduct): HTMLElement` - основной метод для отображения карточки:
  - Вызывает базовый метод `render` для установки общих свойств.
  - Возвращает контейнер карточки.

#### Типы, связанные с классом

- `IProduct` - интерфейс товара.
- `IEvents` - интерфейс системы событий, используется для генерации событий:
  - `product:selected` - при выборе товара для предпросмотра.

#### Итог

Класс `Card` предоставляет лаконичный и расширяемый способ отображения карточки товара, управления её состоянием и интеграции с системой событий для взаимодействия с другими компонентами приложения. Благодаря выносу общей логики в базовый класс, код `Card` остаётся простым и легко поддерживаемым.

### 6. Класс `CardList`

Класс `CardList` реализует компонент для отображения списка карточек товаров в пользовательском интерфейсе. Он наследуется от базового класса `Component<ICardList>` и предназначен для управления коллекцией элементов-карточек, которые формируются заранее и передаются в компонент для отображения. Класс интегрируется с системой событий через интерфейс `IEvents`, что позволяет реагировать на события приложения.

#### Конструктор

`constructor(container: HTMLElement, events: IEvents)`

- Принимает контейнер для размещения карточек (`container`) и экземпляр системы событий (`events`).
- Вызывает конструктор базового класса для инициализации компонента.

#### Методы класса

- `render(data: ICardList): HTMLElement`
  - Принимает объект с массивом элементов-карточек (`items: HTMLElement[]`).
  - Полностью очищает содержимое контейнера и добавляет новые карточки с помощью `replaceChildren`.
  - Возвращает контейнер с обновлённым содержимым.

#### Типы, связанные с классом

- `ICardList` - интерфейс, определяющий структуру данных для компонента:
  - `items: HTMLElement[]` - массив элементов-карточек для отображения.
- `IEvents` - интерфейс системы событий, используется для подписки и генерации событий.

#### Итог

Класс `CardList` обеспечивает простой и эффективный способ отображения коллекции карточек товаров. Он позволяет динамически обновлять содержимое галереи, интегрируется с системой событий приложения и легко расширяется для поддержки дополнительных сценариев взаимодействия с пользователем.

### 7. Класс `Contacts`

Класс `Contacts` реализует компонент формы для ввода контактных данных пользователя (email и телефон) на этапе оформления заказа. Он наследуется от базового класса `Form<IOrder>` и предоставляет методы для управления состоянием полей, валидации и интеграции с системой событий через интерфейс `IEvents`.

#### Конструктор

`constructor(container: HTMLFormElement, events: IEvents)`

- Принимает контейнер формы (`container`) и экземпляр системы событий (`events`).
- Инициализирует элементы формы:
  - Поле для ввода телефона (`_phone`)
  - Поле для ввода email (`_email`)
- Добавляет обработчики событий:
  - На отправку формы: предотвращает стандартное поведение и эмитит событие `contacts:submit` с текущими значениями полей.
  - На изменение любого из полей: эмитит событие `contacts:change` с текущими значениями полей.

#### Поля класса

- `_phone: HTMLInputElement` - поле для ввода телефона пользователя.
- `_email: HTMLInputElement` - поле для ввода email пользователя.

#### Методы класса

- `protected get values()` - возвращает объект с текущими значениями полей `email` и `phone`.
- `set phone(value: string)` - устанавливает значение поля телефона.
- `set email(value: string)` - устанавливает значение поля email.

#### Типы, связанные с классом

- `IOrder` - интерфейс заказа, определяет структуру данных, с которыми работает форма.
- `IEvents` - интерфейс системы событий, используется для генерации событий:
  - `contacts:submit` - при отправке формы контактов.
  - `contacts:change` - при изменении любого поля формы.

#### Итог

Класс `Contacts` предоставляет удобный и расширяемый способ управления формой ввода контактных данных пользователя. Его методы позволяют легко получать и изменять значения полей, а также интегрироваться с системой событий для передачи данных другим компонентам приложения.

### 8. Класс `Header`

Класс `Header` реализует компонент шапки сайта, отображающий логотип и кнопку корзины с динамическим счетчиком товаров. Он наследуется от базового класса `Component<{}>` и предоставляет методы для управления счетчиком корзины и обработки пользовательских событий. Класс интегрируется с системой событий через интерфейс `IEvents`, что позволяет уведомлять другие части приложения о действиях пользователя.

#### Конструктор

`constructor(container: HTMLElement, events: IEvents)`

- Принимает контейнер шапки (`container`) и экземпляр системы событий (`events`).
- Инициализирует элементы интерфейса:
  - Счетчик товаров в корзине (`basketCounter`)
  - Кнопку открытия корзины (`basketButton`)
- Добавляет обработчик клика по кнопке корзины:
  - При клике эмитит событие `basket:open` для открытия корзины.

#### Поля класса

- `basketCounter: HTMLElement` - элемент для отображения количества товаров в корзине.
- `basketButton: HTMLElement` - кнопка для открытия корзины.

#### Методы класса

- `updateBasketCounter(count: number): void`
  - Обновляет текст счетчика корзины, устанавливая текущее количество товаров.

#### Типы, связанные с классом

- `IEvents` - интерфейс системы событий, используется для генерации событий:
  - `basket:open` - при клике на кнопку корзины.

#### Итог

Класс `Header` обеспечивает отображение и обновление счетчика корзины в шапке сайта, а также интеграцию с системой событий для открытия корзины. Это делает его важным элементом пользовательского интерфейса и взаимодействия с корзиной товаров.

### 9. Класс `Preview`

Класс `Preview` реализует компонент предпросмотра карточки товара в модальном окне. Он наследуется от базового класса `ProductView` и предоставляет методы для отображения информации о товаре, управления состоянием кнопки и обработки пользовательских событий. Класс интегрируется с системой событий через интерфейс `IEvents`, что позволяет уведомлять другие части приложения о действиях пользователя.

#### Конструктор

`constructor(container: HTMLElement, events: IEvents)`

- Принимает контейнер карточки предпросмотра (`container`) и экземпляр системы событий (`events`).
- Инициализирует элементы интерфейса, необходимые для работы предпросмотра:
  - Заголовок товара (`_title`) - унаследовано от `ProductView`
  - Цена товара (`_price`) - унаследовано от `ProductView`
  - Категория товара (`_category`) - унаследовано от `ProductView`
  - Изображение товара (`_image`) - унаследовано от `ProductView`
  - Описание товара (`_description`) - унаследовано от `ProductView`
  - Кнопка "В корзину" (`_button`) - поле класса `Preview`
- Добавляет обработчик клика по кнопке "В корзину":
  - Если товар не бесплатный - эмитит событие `preview:button-click` с идентификатором товара.

#### Поля класса

- `_button: HTMLButtonElement` - кнопка "В корзину" в предпросмотре товара.

> Остальные поля (`_title`, `_price`, `_category`, `_image`, `_description`) определены и инициализируются в базовом классе `ProductView`.

#### Методы класса

- `set buttonText(value: string)` - устанавливает текст кнопки "В корзину".
- `override set price(value: number | null)` - переопределяет сеттер цены, вызывает базовую реализацию и дополнительно обновляет текст, состояние и класс кнопки "В корзину".
- `override render(data: IProduct): HTMLElement` - основной метод для отображения карточки предпросмотра:
  - Вызывает базовый метод `render` для установки общих свойств.
  - Устанавливает описание товара.
  - Возвращает контейнер карточки предпросмотра.

#### Типы, связанные с классом

- `IProduct` - интерфейс товара.
- `IEvents` - интерфейс системы событий, используется для генерации событий:
  - `preview:button-click` - при клике по кнопке "В корзину" в предпросмотре.

#### Итог

Класс `Preview` предоставляет специализированный компонент для отображения полной информации о товаре в модальном окне предпросмотра, управления состоянием кнопки "В корзину" и интеграции с системой событий для взаимодействия с другими частями приложения. Благодаря наследованию от базового класса, общая логика вынесена в `ProductView`, а уникальное поведение реализовано непосредственно в `Preview`.

### 10. Класс `Order`

Класс `Order` реализует компонент формы для выбора способа оплаты и ввода адреса доставки на этапе оформления заказа. Он наследуется от базового класса `Form<IOrder>` и предоставляет методы для управления состоянием кнопок оплаты, адреса, а также интеграции с системой событий через интерфейс `IEvents`.

#### Конструктор

`constructor(container: HTMLFormElement, events: IEvents)`

- Принимает контейнер формы (`container`) и экземпляр системы событий (`events`).
- Инициализирует элементы формы:
  - Массив кнопок выбора способа оплаты (`_buttons`)
  - Контейнер кнопок оплаты (`_buttonsContainer`)
  - Поле ввода адреса (`_address`)
- Вызывает метод `init()` для установки начального состояния формы.
- Добавляет обработчики событий:
  - Клик по кнопке оплаты: обновляет активную кнопку, изменяет способ оплаты, эмитит события `payment:method:changed` и `order:payment:change`.
  - Ввод адреса: эмитит событие `order:address:change` с текущими данными.
  - Отправка формы: предотвращает стандартное поведение и эмитит событие `order:submit` с текущими данными.

#### Поля класса

- `_buttons: HTMLButtonElement[]` - массив кнопок выбора способа оплаты.
- `_buttonsContainer: HTMLElement` - контейнер кнопок оплаты.
- `_address: HTMLInputElement` - поле для ввода адреса доставки.
- `_payment: string` - текущий выбранный способ оплаты (`'online'` или `'cash'`).

#### Методы класса

- `protected init()` - устанавливает начальное состояние формы (валидность и ошибки).
- `protected updateButtons(name: string)` - обновляет активную кнопку оплаты и внутреннее состояние поля `_payment`.
- `set address(value: string)` - устанавливает значение поля адреса.
- `get address(): string` - возвращает текущее значение поля адреса.
- `render(state: Partial<IOrder> & IFormState): HTMLFormElement` - обновляет состояние формы: способ оплаты, валидность, ошибки; возвращает контейнер формы.

#### Типы, связанные с классом

- `IOrder` - интерфейс заказа, определяет структуру данных формы.
- `IFormState` - интерфейс состояния формы (валидность, ошибки).
- `IEvents` - интерфейс системы событий, используется для генерации событий:
  - `payment:method:changed` - при изменении способа оплаты.
  - `order:payment:change` - при изменении способа оплаты или адреса.
  - `order:address:change` - при изменении адреса.
  - `order:submit` - при отправке формы заказа.

#### Итог

Класс `Order` предоставляет удобный и расширяемый способ управления формой выбора способа оплаты и ввода адреса доставки. Его методы позволяют гибко управлять состоянием кнопок, валидностью и интеграцией с системой событий для передачи данных другим компонентам приложения.

### 11. Класс `Page`

Класс `Page` реализует компонент главной страницы приложения и отвечает за отображение каталога товаров, счетчика корзины и обработку открытия корзины. Он наследуется от базового класса `View<IPage>` и предоставляет методы для обновления интерфейса и интеграции с системой событий через интерфейс `IEvents`.

#### Конструктор

`constructor(container: HTMLElement, events: IEvents)`

- Принимает контейнер страницы (`container`) и экземпляр системы событий (`events`).
- Инициализирует элементы интерфейса:
  - Счетчик товаров в корзине (`basketCounter`)
  - Контейнер каталога товаров (`cardCatalog`)
  - Кнопку открытия корзины (`basketButton`)
- Добавляет обработчик клика по кнопке корзины:
  - При клике эмитит событие `basket:open` для открытия корзины.

#### Поля класса

- `basketCounter: HTMLElement` - элемент для отображения количества товаров в корзине.
- `cardCatalog: HTMLElement` - контейнер для отображения карточек товаров.
- `basketButton: HTMLElement` - кнопка для открытия корзины.

#### Методы класса

- `set counter(value: number)` - обновляет текст счетчика корзины, устанавливая текущее количество товаров.
- `set catalog(items: HTMLElement[])` - очищает и наполняет контейнер каталога новыми карточками товаров.

#### Типы, связанные с классом

- `IPage` - интерфейс страницы, определяет структуру данных для компонента.
- `IEvents` - интерфейс системы событий, используется для генерации событий:
  - `basket:open` - при клике на кнопку корзины.

#### Итог

Класс `Page` обеспечивает отображение каталога товаров и счетчика корзины на главной странице, а также интеграцию с системой событий для открытия корзины. Это делает его важной частью пользовательского интерфейса и взаимодействия с корзиной товаров.

### 12. Класс `ProductView`

Абстрактный класс `ProductView` реализует базовый компонент для отображения информации о товаре и служит основой для специализированных компонентов карточек (`Card`, `Preview`). Он наследуется от класса `Component<IProduct>` и инкапсулирует общие свойства и методы для работы с DOM-элементами карточки товара, а также предоставляет универсальную логику для отображения и обновления данных о товаре.

#### Поля класса

- `_title: HTMLElement` - элемент заголовка товара.
- `_category: HTMLElement` - элемент категории товара.
- `_image: HTMLImageElement` - элемент изображения товара.
- `_description?: HTMLElement | null` - элемент описания товара (может отсутствовать).
- `_price: HTMLElement` - элемент цены товара.

#### Сеттеры и геттеры

- `set id(value: string)` / `get id(): string` - геттер и сеттер для идентификатора товара (через `dataset` контейнера).
- `set title(value: string)` - устанавливает текст заголовка.
- `set category(value: string)` - устанавливает текст и CSS-класс категории на основе справочника категорий.
- `set image(value: string)` - устанавливает изображение товара и alt-текст.
- `set description(value: string)` - устанавливает описание товара, если элемент существует.
- `set price(value: number | null)` - устанавливает цену товара, отображает "Бесплатно" для бесплатных товаров.
- `get isFree(): boolean` - возвращает `true`, если товар бесплатный (по тексту цены).

#### Методы класса

- `render(data: IProduct): HTMLElement` - основной метод для отображения карточки товара:
  - Устанавливает идентификатор, заголовок, категорию, изображение и цену на основе переданных данных.
  - Возвращает контейнер карточки.

#### Используемые типы

- `IProduct` - интерфейс товара.

#### Итог

Абстрактный класс `ProductView` обеспечивает единый интерфейс и общую логику для всех компонентов, отображающих карточку товара. Благодаря этому дочерние классы (`Card`, `Preview`) могут переопределять или расширять только уникальное поведение, не дублируя базовые операции по отображению и обновлению информации о товаре. Такой подход повышает переиспользуемость кода, облегчает поддержку и масштабирование приложения.

## Presenter (Презентер)

Код презентера не выделен в отдельный класс, а размещен в основном скрипте приложения.

## Слой коммуникации

### 1. Класс `WebLarekApi`

Класс `WebLarekApi` реализует слой взаимодействия с серверным API для получения данных о товарах и оформления заказов. Он наследуется от базового класса `Api` и реализует интерфейс `IWebLarekApi`, предоставляя типизированные методы для работы с продуктами и заказами. Класс также добавляет корректные пути к изображениям через CDN.

#### Конструктор

`constructor(cdn: string, baseUrl: string, options?: RequestInit)`

- Принимает адрес CDN (`cdn`), базовый URL API (`baseUrl`) и дополнительные опции запроса (`options`).
- Инициализирует базовый класс `Api` с параметрами.
- Сохраняет адрес CDN для последующей обработки изображений.

#### Методы класса

- `getProducts(): Promise<IProductList>`

  - Загружает список товаров с сервера (`/product`).
  - Для каждого товара в массиве `items` добавляет к пути изображения адрес CDN и меняет расширение `.svg` на `.png`.
  - Возвращает промис с обновлённым списком товаров.
  - В случае ошибки выводит сообщение в консоль и пробрасывает ошибку дальше.

- `getProductById(id: string): Promise<IProduct | IProductNotFound>`

  - Загружает данные о конкретном товаре по его идентификатору (`/product/:id`).
  - Если сервер возвращает ошибку (`error` в ответе), возвращает объект ошибки.
  - Для успешного ответа добавляет к пути изображения адрес CDN и меняет расширение `.svg` на `.png`.
  - Возвращает промис с данными товара или ошибкой.

- `placeOrder(order: IOrder): Promise<IOrderSuccess | IOrderError>`
  - Отправляет заказ на сервер (`/order`) методом POST.
  - Если сервер возвращает ошибку (`error` в ответе), возвращает объект ошибки.
  - В случае успеха возвращает объект успешного оформления заказа.

#### Типы, связанные с классом

- `IWebLarekApi` - интерфейс, определяющий контракт для API:
  - `getProducts()`
  - `getProductById(id: string)`
  - `placeOrder(order: IOrder)`
- `IProductList`, `IProduct`, `IProductNotFound` - интерфейсы, описывающие структуру данных товаров.
- `IOrder`, `IOrderSuccess`, `IOrderError` - интерфейсы для работы с заказами.

#### Итог

Класс `WebLarekApi` обеспечивает типизированное, удобное и безопасное взаимодействие с серверным API для загрузки товаров и оформления заказов. Он автоматически корректирует пути к изображениям, обрабатывает ошибки и интегрируется с остальной архитектурой приложения через чётко определённые интерфейсы.

## Основные типы данных и интерфейсы

```
interface IProductList {
	total: number; // Общее количество продуктов
	items: IProduct[]; // Массив продуктов
}

interface IProduct {
	id: string; // Уникальный идентификатор продукта
	description: string; // Описание продукта
	image: string; // Путь к изображению продукта
	title: string; // Название продукта
	category: string; // Категория продукта
	price: number | null; // Цена продукта (может быть null)
}

interface IProductNotFound {
	error: string; // Сообщение об ошибке ("NotFound")
}

interface IOrder {
	payment: string; // Способ оплаты ("online")
	email: string; // Электронная почта
	phone: string; // Телефон
	address: string; // Адрес доставки
	total: number; // Общая сумма заказа
	items: string[]; // Массив идентификаторов продуктов
}

interface IOrderSuccess {
	id: string; // Уникальный идентификатор заказа
	total: number; // Общая сумма заказа
}

interface IOrderError {
	error: string; // Сообщение об ошибке
}

interface IAppState {
	catalog: IProduct[]; // Каталог всех доступных продуктов.
	basket: string[]; // Массив ID продуктов, добавленных в корзину.
	preview: string | null; // ID продукта, который отображается в предпросмотре (или null, если предпросмотра нет).
	order: {
		payment: string; // Способ оплаты ("online")
		email: string; // Электронная почта
		phone: string; // Телефон
		address: string; // Адрес доставки
		total: number; // Общая сумма заказа
		items: string[]; // Массив ID продуктов в заказе
	} | null; // Информация о текущем заказе (или null, если заказа нет).
	loading: boolean; // Флаг загрузки данных (например, при загрузке каталога продуктов).
	paymentMethod: 'online' | 'cash' | null; // Выбранный способ оплаты
}

type IBasketItem = Pick<IProduct, 'id' | 'title' | 'price'> & {
	quantity: number; // Количество единиц продукта в корзине.
};

interface IFormState {
	valid: boolean; // Флаг валидности формы
	errors: string[]; // Массив сообщений об ошибках
}

interface IBasketView {
	items: IBasketItem[]; // Массив продуктов в корзине с их количеством
	total: number; // Общая стоимость всех продуктов в корзине
	selected: string[]; // Массив ID выбранных продуктов (например, для удаления)
}

interface IPage {
	counter: number;
	catalog: HTMLElement[];
}
```
